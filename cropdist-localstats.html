<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andy Lyons">
<meta name="dcterms.date" content="2024-09-25">

<title>Summarizing Crop Distribution for a Polygon</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="cropdist-localstats_files/libs/clipboard/clipboard.min.js"></script>
<script src="cropdist-localstats_files/libs/quarto-html/quarto.js"></script>
<script src="cropdist-localstats_files/libs/quarto-html/popper.min.js"></script>
<script src="cropdist-localstats_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="cropdist-localstats_files/libs/quarto-html/anchor.min.js"></script>
<link href="cropdist-localstats_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="cropdist-localstats_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="cropdist-localstats_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="cropdist-localstats_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="cropdist-localstats_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="cropdist-localstats_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="cropdist-localstats_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<script src="cropdist-localstats_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>

<link href="cropdist-localstats_files/libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">

<script src="cropdist-localstats_files/libs/leaflet-1.3.1/leaflet.js"></script>

<link href="cropdist-localstats_files/libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">

<script src="cropdist-localstats_files/libs/proj4-2.6.2/proj4.min.js"></script>

<script src="cropdist-localstats_files/libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>

<link href="cropdist-localstats_files/libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">

<script src="cropdist-localstats_files/libs/leaflet-binding-2.2.2/leaflet.js"></script>

<script src="cropdist-localstats_files/libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>

<script src="cropdist-localstats_files/libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>

<link href="cropdist-localstats_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="cropdist-localstats_files/libs/pagedtable-1.1/js/pagedtable.js"></script>



</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#summary" id="toc-summary" class="nav-link active" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#import-points" id="toc-import-points" class="nav-link" data-scroll-target="#import-points">Import points</a></li>
  <li><a href="#convert-points-to-spatial-object" id="toc-convert-points-to-spatial-object" class="nav-link" data-scroll-target="#convert-points-to-spatial-object">Convert points to spatial object</a></li>
  <li><a href="#open-a-connection-to-the-2021-statewide-crop-mapping-data" id="toc-open-a-connection-to-the-2021-statewide-crop-mapping-data" class="nav-link" data-scroll-target="#open-a-connection-to-the-2021-statewide-crop-mapping-data">Open a Connection to the 2021 Statewide Crop Mapping data</a></li>
  <li><a href="#exploring-the-statewide-crop-distribution-layer" id="toc-exploring-the-statewide-crop-distribution-layer" class="nav-link" data-scroll-target="#exploring-the-statewide-crop-distribution-layer">Exploring the Statewide Crop Distribution Layer</a></li>
  <li><a href="#which-attribute-field-contains-the-crop" id="toc-which-attribute-field-contains-the-crop" class="nav-link" data-scroll-target="#which-attribute-field-contains-the-crop">Which attribute field contains ‘the crop’?</a></li>
  <li><a href="#figuring-out-the-codes" id="toc-figuring-out-the-codes" class="nav-link" data-scroll-target="#figuring-out-the-codes">Figuring out the codes</a></li>
  <li><a href="#import-the-crop-type-codes" id="toc-import-the-crop-type-codes" class="nav-link" data-scroll-target="#import-the-crop-type-codes">Import the Crop Type codes</a></li>
  <li><a href="#create-a-buffer" id="toc-create-a-buffer" class="nav-link" data-scroll-target="#create-a-buffer">Create a buffer</a></li>
  <li><a href="#import-the-crop-distribution-data" id="toc-import-the-crop-distribution-data" class="nav-link" data-scroll-target="#import-the-crop-distribution-data">Import the Crop Distribution Data</a></li>
  <li><a href="#intersect-the-crop-polygons-with-the-buffer" id="toc-intersect-the-crop-polygons-with-the-buffer" class="nav-link" data-scroll-target="#intersect-the-crop-polygons-with-the-buffer">Intersect the crop polygons with the buffer</a></li>
  <li><a href="#compute-the-percent-area-of-each-crop" id="toc-compute-the-percent-area-of-each-crop" class="nav-link" data-scroll-target="#compute-the-percent-area-of-each-crop">Compute the percent area of each crop</a></li>
  <li><a href="#add-the-non-crop-category" id="toc-add-the-non-crop-category" class="nav-link" data-scroll-target="#add-the-non-crop-category">Add the ‘non-crop’ category:</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Summarizing Crop Distribution for a Polygon</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Andy Lyons </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 25, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This notebook demonstrates the code that can be used to summarize the distribution of crops around a point. It uses the 2021<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <a href="https://data.cnra.ca.gov/dataset/statewide-crop-mapping">Statewide Crop Mapping Layer</a> from <a href="https://data.cnra.ca.gov/organization/dwr">CA DWR</a>. More specifically, this notebook shows how to:</p>
<ul>
<li>import a set of points from a CSV file</li>
<li>create a spatial object from the CSV file</li>
<li>select one of the points</li>
<li>create a 1km buffer around the point</li>
<li>import the 2021 Statewide Crop Mapping Layer from a downloaded file geodatabase for the area of the buffer</li>
<li>intersect the buffer with the crop polygons</li>
<li>compute for each crop the percent of the total area of the buffer</li>
</ul>
<p>This demonstration code is intended to be educational, but can be adapted into a “production script” that chugs through a series of points and a range of buffer sizes to characterize the landscape around selected points. The methods can also be adapted for other polygons (e.g., ground water basins, counties, etc.)</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>We first load libraries:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(units)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br>
</p>
<p>Define a few EPSG codes (i.e., projections) that we’ll use later:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>epsg_utm11n_wgs84 <span class="ot">&lt;-</span> <span class="dv">32611</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>epsg_geo_nad83 <span class="ot">&lt;-</span> <span class="dv">4269</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>epsg_geo_wgs84 <span class="ot">&lt;-</span> <span class="dv">4326</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br>
</p>
</section>
<section id="import-points" class="level2">
<h2 class="anchored" data-anchor-id="import-points">Import points</h2>
<p>First, we load some points from a CSV file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>farms_tbl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"farm_pts.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 5 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): ptid
dbl (2): lon, lat

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>farms_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["ptid"],"name":[1],"type":["chr"],"align":["left"]},{"label":["lon"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["lat"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"A","2":"-119.4320","3":"35.744"},{"1":"B","2":"-119.3640","3":"35.692"},{"1":"C","2":"-119.3659","3":"35.656"},{"1":"D","2":"-119.4280","3":"35.610"},{"1":"E","2":"-119.4610","3":"35.556"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Importing Points">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Importing Points
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the points are already in a GIS format (e.g., Shapefile, KML), we would import them using <code>st_read()</code> (and skip the next step).</p>
</div>
</div>
<p><br>
</p>
</section>
<section id="convert-points-to-spatial-object" class="level2">
<h2 class="anchored" data-anchor-id="convert-points-to-spatial-object">Convert points to spatial object</h2>
<p>Next, we convert this to a simple feature point layer in UTM Zone 11<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>farms_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(farms_tbl, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> epsg_geo_wgs84) <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(epsg_utm11n_wgs84)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br>
</p>
<p>Plot these points in a leaflet map to see where they are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> <span class="fu">st_transform</span>(farms_sf, epsg_geo_wgs84)) <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(<span class="st">"Esri.WorldImagery"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  leaflet<span class="sc">::</span><span class="fu">addCircleMarkers</span>(<span class="at">stroke =</span> <span class="cn">FALSE</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fillColor =</span> <span class="st">"#f00"</span>, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fillOpacity =</span> <span class="fl">0.8</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">popup =</span> <span class="sc">~</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item" id="htmlwidget-785566a5f1396e237cbe" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-785566a5f1396e237cbe">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["Esri.WorldImagery",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addCircleMarkers","args":[[35.74400000000001,35.69199999999999,35.656,35.61,35.556],[-119.432,-119.364,-119.3659,-119.428,-119.461],10,null,null,{"interactive":true,"className":"","stroke":false,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#f00","fillOpacity":0.8},null,null,["function (.variables, drop = FALSE) ","{","    lifecycle::deprecate_stop(\"0.5.0\", \"id()\", \"vctrs::vec_group_id()\")","}"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[35.556,35.74400000000001],"lng":[-119.461,-119.364]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p><br>
</p>
</section>
<section id="open-a-connection-to-the-2021-statewide-crop-mapping-data" class="level2">
<h2 class="anchored" data-anchor-id="open-a-connection-to-the-2021-statewide-crop-mapping-data">Open a Connection to the 2021 Statewide Crop Mapping data</h2>
<p>This notebook uses a local copy of the 2021 Statewide Crop Mapping saved as a file geodatabase. This copy was downloaded from the <a href="https://data.cnra.ca.gov/dataset/statewide-crop-mapping/resource/cd1ce211-ac75-44b4-9ea4-345ce2fd0548">CNRA Open Data Hub</a> and unzipped.</p>
<p>We are using a local copy of the crop distribution data because:</p>
<ol type="1">
<li>accessing a local file geodatabase will give us the fastest performance (compared to downloading the data from the cloud, although that can also be done).</li>
<li>the size of the data is manageable (the zip file is 90 MB, the unzipped GDB is 207 MB).</li>
<li>the links to the online layers (i.e., Map Service) seem to be broken (or require a login), so there is not much alternative.</li>
</ol>
<p>Create the connection and view the layers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dwr_cropmapping_gdb <span class="ot">&lt;-</span> <span class="st">"i15_Crop_Mapping_2021_GDB/i15_Crop_Mapping_2021.gdb"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.exists</span>(dwr_cropmapping_gdb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(dwr_cropmapping_gdb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Driver: OpenFileGDB 
Available layers:
             layer_name             geometry_type features fields crs_name
1 i15_Crop_Mapping_2021 3D Measured Multi Polygon   431145     56    NAD83</code></pre>
</div>
</div>
<p><br>
</p>
</section>
<section id="exploring-the-statewide-crop-distribution-layer" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-statewide-crop-distribution-layer">Exploring the Statewide Crop Distribution Layer</h2>
<p>The best way to explore the Statewide Crop Distribution Layer is to open it up in ArcGIS Pro. The zip file from DWR contains both a file geodatabase as well as an ArcGIS Pro layer file (<code>CropMapping2021_Legend.lyrx</code>). Double-click the layer file to open it up in ArcGIS Pro. You will probably need to reestablish the link to the data (layer properties &gt; source), but then you’re good to go.</p>
<p>The file geodatabase appears to be the only source for ‘metadata’. In other words, DWR has not published the metadata anywhere else, however copy of the metadata for the 2021 crop distribution data can also be found <a href="https://ucanr-igis.github.io/sketchbook/i15_Crop_Mapping_2021_metdata.htm">here</a>. However even the ‘metadata’ does not provide a field-by-field description, but you can make educated guesses by looking at the field properties and domains (see below).</p>
<p><br>
</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exploring the Data in ArcGIS Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exploring the Data in ArcGIS Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p>Reading the metadata and exploring the data more thoroughly in ArcGIS Pro is an extremely good idea if you’ll be using these data for research. In addition to the <code>MAIN_CROP</code> field (which is all we’re using in this notebook), there are 56 other fields that contain useful information including multi-cropping characteristics, crop category (as opposed to crop type), year the crop was established (i.e., for perennial crops), whether the classification was updated / revised by DWR, notes from the analyst, etc.</p>
</div>
</div>
<p><br>
</p>
</section>
<section id="which-attribute-field-contains-the-crop" class="level2">
<h2 class="anchored" data-anchor-id="which-attribute-field-contains-the-crop">Which attribute field contains ‘the crop’?</h2>
<p>The attribute table for the Statewide Crop Mapping layer has <strong>57 fields</strong>. Determining which field has the “crop” name requires some sleuthing, as there are several candidates whose name suggest it might be the crop name. DWR unfortunately does not publish a data dictionary for the data, but if you open the file geodatabase in ArcGIS Pro you can see i) the ‘domains’ (list of codes and their descriptions used in several fields), and ii) <a href="https://ucanr-igis.github.io/sketchbook/i15_Crop_Mapping_2021_metdata.htm">descriptive metadata</a> that contains clues about the methodology.</p>
<p>The code in this notebook only imports <strong>5</strong> of the 57 fields. The field we will use below as “the crop” is <strong><code>MAIN_CROP</code></strong>, which the metadata describes as:</p>
<div style="margin-left; padding-left:1em; font-style:italic;">
<p>A new column for the 2019, 2020, and 2021 datasets is called ‘MAIN_CROP’. This column indicates which field Land IQ identified as the main season crop for the WY representing the crop grown during the dominant growing season for each county.</p>
</div>
<p><br>
</p>
</section>
<section id="figuring-out-the-codes" class="level2">
<h2 class="anchored" data-anchor-id="figuring-out-the-codes">Figuring out the codes</h2>
<p>Many of the attribute fields in the crop distribution layer contain codes or abbreviations. The descriptions that go with these codes are not documented anywhere online, unfortunately. However if you open the File Geodatabase in ArcGIS Pro, you view the ‘domains’ (which is what ESRI calls code lists used in attribute tables). For convenience, the domains have been also exported as tables saved in another file geodatabase: <code>Crop_Mapping_2021_domains.gdb</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>domains_gdb <span class="ot">&lt;-</span> <span class="st">"Crop_Mapping_2021_domains.gdb"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.exists</span>(domains_gdb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(domains_gdb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Driver: OpenFileGDB 
Available layers:
         layer_name geometry_type features fields crs_name
1     allClas_dom_5            NA       27      2     &lt;NA&gt;
2 allCropType_dom_3            NA       59      2     &lt;NA&gt;
3  AllIrrigTypA_dom            NA        3      2     &lt;NA&gt;
4  AllIrrigTypB_dom            NA       17      2     &lt;NA&gt;
5   AllMultiUse_dom            NA        6      2     &lt;NA&gt;
6      allNotes_dom            NA      129      2     &lt;NA&gt;
7       AllPCNT_dom            NA      101      2     &lt;NA&gt;
8 allSpecCond_dom_2            NA       20      2     &lt;NA&gt;
9 allSubclass_dom_1            NA       33      2     &lt;NA&gt;</code></pre>
</div>
</div>
<p><br>
</p>
<p>All 9 of these ‘domains’ are code lists used in one or more of the 57 fields in the attribute table.</p>
<p><br>
</p>
</section>
<section id="import-the-crop-type-codes" class="level2">
<h2 class="anchored" data-anchor-id="import-the-crop-type-codes">Import the Crop Type codes</h2>
<p>Let’s import the “crop types” domain:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>croptypes_tbl <span class="ot">&lt;-</span> <span class="fu">st_read</span>(domains_gdb, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">layer =</span> <span class="st">"allCropType_dom_3"</span>, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">as_tibble =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">code =</span> Code, <span class="at">description =</span> Description)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(croptypes_tbl, <span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">code</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">****</td>
<td style="text-align: left;">****</td>
</tr>
<tr class="even">
<td style="text-align: left;">C</td>
<td style="text-align: left;">Citrus and Subtropical - No Subclass</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C4</td>
<td style="text-align: left;">Dates</td>
</tr>
<tr class="even">
<td style="text-align: left;">C5</td>
<td style="text-align: left;">Avocados</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C6</td>
<td style="text-align: left;">Olives</td>
</tr>
<tr class="even">
<td style="text-align: left;">C7</td>
<td style="text-align: left;">Subtropical Fruits Misc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C8</td>
<td style="text-align: left;">Kiwis</td>
</tr>
<tr class="even">
<td style="text-align: left;">C10</td>
<td style="text-align: left;">Eucalyptus</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D1</td>
<td style="text-align: left;">Apples</td>
</tr>
<tr class="even">
<td style="text-align: left;">D2</td>
<td style="text-align: left;">Apricots</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D3</td>
<td style="text-align: left;">Cherries Cherries</td>
</tr>
<tr class="even">
<td style="text-align: left;">D5</td>
<td style="text-align: left;">Peaches and Nectarines</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D6</td>
<td style="text-align: left;">Pears</td>
</tr>
<tr class="even">
<td style="text-align: left;">D7</td>
<td style="text-align: left;">Plums</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D8</td>
<td style="text-align: left;">Prunes</td>
</tr>
<tr class="even">
<td style="text-align: left;">D10</td>
<td style="text-align: left;">Deciduous - Misc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D12</td>
<td style="text-align: left;">Almonds</td>
</tr>
<tr class="even">
<td style="text-align: left;">D13</td>
<td style="text-align: left;">Walnuts</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D14</td>
<td style="text-align: left;">Pistachios</td>
</tr>
<tr class="even">
<td style="text-align: left;">D15</td>
<td style="text-align: left;">Pomegranates</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D17</td>
<td style="text-align: left;">Pecans</td>
</tr>
<tr class="even">
<td style="text-align: left;">F1</td>
<td style="text-align: left;">Cotton</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F2</td>
<td style="text-align: left;">Safflower</td>
</tr>
<tr class="even">
<td style="text-align: left;">F5</td>
<td style="text-align: left;">Sugar beets</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F10</td>
<td style="text-align: left;">Beans (dry)</td>
</tr>
<tr class="even">
<td style="text-align: left;">F11</td>
<td style="text-align: left;">Field Misc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">F12</td>
<td style="text-align: left;">Sunflowers</td>
</tr>
<tr class="even">
<td style="text-align: left;">F16</td>
<td style="text-align: left;">Corn, Sorghum or Sudan (grouped for remote sensing classification only)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">G2</td>
<td style="text-align: left;">Wheat</td>
</tr>
<tr class="even">
<td style="text-align: left;">G6</td>
<td style="text-align: left;">Grain and Hay - Misc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">I1</td>
<td style="text-align: left;">Idle - Land not cropped in current or prior year, but within last 3 yrs.</td>
</tr>
<tr class="even">
<td style="text-align: left;">I4</td>
<td style="text-align: left;">Idle - Long Term - land consistently idle for four or more years</td>
</tr>
<tr class="odd">
<td style="text-align: left;">P1</td>
<td style="text-align: left;">Alfalfa and alfalfa mixtures</td>
</tr>
<tr class="even">
<td style="text-align: left;">P3</td>
<td style="text-align: left;">Pasture - Mixed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">P4</td>
<td style="text-align: left;">Pasture - Native Improved</td>
</tr>
<tr class="even">
<td style="text-align: left;">P5</td>
<td style="text-align: left;">Pasture - Induced High Water</td>
</tr>
<tr class="odd">
<td style="text-align: left;">P6</td>
<td style="text-align: left;">Pasture - Miscellaneous Grasses</td>
</tr>
<tr class="even">
<td style="text-align: left;">P7</td>
<td style="text-align: left;">Pasture - Turf Farms</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R1</td>
<td style="text-align: left;">Rice</td>
</tr>
<tr class="even">
<td style="text-align: left;">R2</td>
<td style="text-align: left;">Rice - Wild</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T4</td>
<td style="text-align: left;">Cole crops (mixture of T22-T25)</td>
</tr>
<tr class="even">
<td style="text-align: left;">T6</td>
<td style="text-align: left;">Carrots</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T9</td>
<td style="text-align: left;">Melons, Squash, and Cucumbers</td>
</tr>
<tr class="even">
<td style="text-align: left;">T10</td>
<td style="text-align: left;">Onions and Garlic</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T12</td>
<td style="text-align: left;">Potatoes</td>
</tr>
<tr class="even">
<td style="text-align: left;">T13</td>
<td style="text-align: left;">Sweet Potatoes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T16</td>
<td style="text-align: left;">Flowers, nursery and Christmas Tree Farms</td>
</tr>
<tr class="even">
<td style="text-align: left;">T18</td>
<td style="text-align: left;">Truck Crops - Misc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T19</td>
<td style="text-align: left;">Bushberries</td>
</tr>
<tr class="even">
<td style="text-align: left;">T20</td>
<td style="text-align: left;">Strawberries</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T21</td>
<td style="text-align: left;">Peppers (Chili, Bell, etc.)</td>
</tr>
<tr class="even">
<td style="text-align: left;">T27</td>
<td style="text-align: left;">Greenhouse</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T30</td>
<td style="text-align: left;">Lettuce or Leafy Greens (grouped for remote sensing classification only)</td>
</tr>
<tr class="even">
<td style="text-align: left;">T32</td>
<td style="text-align: left;">Tomatoes (all)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U</td>
<td style="text-align: left;">Urban - Unspecified Residential, Commercial, Industrial</td>
</tr>
<tr class="even">
<td style="text-align: left;">UL2</td>
<td style="text-align: left;">Urban Landscape - Golf Course Irrigated</td>
</tr>
<tr class="odd">
<td style="text-align: left;">V</td>
<td style="text-align: left;">Vineyards - No Subclass</td>
</tr>
<tr class="even">
<td style="text-align: left;">X</td>
<td style="text-align: left;">Not cropped, or unclassified at the time of remote-sensing analysis. Idle status not determined</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YP</td>
<td style="text-align: left;">Young Perennial (grouped for remote sensing or when CLASS C, D or V is not determined)</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br>
</p>
</section>
<section id="create-a-buffer" class="level2">
<h2 class="anchored" data-anchor-id="create-a-buffer">Create a buffer</h2>
<p>Next, we’ll create a buffer around one of the points to use as the ‘cookie cutter’ for the crop distribution layer. For the rest of this notebook, we’ll be working with just one of the points (but this can be easily adapted by creating a loop).</p>
<p>Set a variable for the selected point:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br>
</p>
<p>Make a 1km buffer around the ith point:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>onefarm_buf1k <span class="ot">&lt;-</span> farms_sf <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="at">dist =</span> <span class="dv">1000</span>) </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>onefarm_buf1k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["ptid"],"name":[1],"type":["chr"],"align":["left"]},{"label":["geometry"],"name":[2],"type":["s_POLYGO"],"align":["right"]}],"data":[{"1":"A","2":"<s_POLYGO>","_rn_":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br>
</p>
<p>See what that looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(onefarm_buf1k<span class="sc">$</span>geometry, <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cropdist-localstats_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br>
</p>
<p>Compute the area of the buffer (we’ll need this further down when we compute the percent area of each crop):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(buff_area_m2 <span class="ot">&lt;-</span> <span class="fu">st_area</span>(onefarm_buf1k))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3140157 [m^2]</code></pre>
</div>
</div>
<p><br>
</p>
</section>
<section id="import-the-crop-distribution-data" class="level2">
<h2 class="anchored" data-anchor-id="import-the-crop-distribution-data">Import the Crop Distribution Data</h2>
<p>Next, we’ll import the crop distribution layer (which is a polygon layer). To save time and memory, we’ll only import polygons that intersect the buffer area by specifying a spatial filter when we call <code>st_read()</code>.</p>
<p>To include a spatial filter when we import the data, we need to define the bounding box and express it as WKT<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> (i.e., a character object). Note that we also have to transform the bounding box to geographic coordinates NAD83, because that’s the CRS of the crop distribution layer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>bbox_wkt <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(onefarm_buf1k) <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(epsg_geo_nad83) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_text</span>()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>bbox_wkt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "POLYGON ((-119.4428 35.73477, -119.4207 35.73521, -119.4212 35.75323, -119.4433 35.75278, -119.4428 35.73477))"</code></pre>
</div>
</div>
<p><br>
</p>
<p>Now we can import the crop distribution layer for the bounding box:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>crpdst_bbox_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> dwr_cropmapping_gdb,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">layer =</span> <span class="st">"i15_Crop_Mapping_2021"</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">wkt_filter =</span> bbox_wkt) <span class="sc">|&gt;</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(epsg_utm11n_wgs84) <span class="sc">|&gt;</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">main_crop =</span> MAIN_CROP, <span class="at">class2 =</span> CLASS2, <span class="at">yr_planted =</span> YR_PLANTED, </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">data_status =</span> DataStatus, <span class="at">multiuse =</span> MULTIUSE) <span class="sc">|&gt;</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(croptypes_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"main_crop"</span> <span class="ot">=</span> <span class="st">"code"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `i15_Crop_Mapping_2021' from data source 
  `D:\GitHub\sandbox\crop_dist\cropdist_zonalstats\i15_Crop_Mapping_2021_GDB\i15_Crop_Mapping_2021.gdb' 
  using driver `OpenFileGDB'
Simple feature collection with 22 features and 56 fields
Geometry type: MULTIPOLYGON
Dimension:     XYZ
Bounding box:  xmin: -119.446 ymin: 35.73202 xmax: -119.4192 ymax: 35.7538
z_range:       zmin: 0 zmax: 0
Geodetic CRS:  NAD83</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(crpdst_bbox_sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["main_crop"],"name":[1],"type":["chr"],"align":["left"]},{"label":["class2"],"name":[2],"type":["chr"],"align":["left"]},{"label":["yr_planted"],"name":[3],"type":["int"],"align":["right"]},{"label":["data_status"],"name":[4],"type":["chr"],"align":["left"]},{"label":["multiuse"],"name":[5],"type":["chr"],"align":["left"]},{"label":["description"],"name":[6],"type":["chr"],"align":["left"]},{"label":["Shape"],"name":[7],"type":["s_MULTIP"],"align":["right"]}],"data":[{"1":"F16","2":"F","3":"NA","4":"Final","5":"D","6":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","7":"<s_MULTIP>","_rn_":"1"},{"1":"F16","2":"F","3":"NA","4":"Final","5":"D","6":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","7":"<s_MULTIP>","_rn_":"2"},{"1":"P1","2":"P","3":"NA","4":"Final","5":"S","6":"Alfalfa and alfalfa mixtures","7":"<s_MULTIP>","_rn_":"3"},{"1":"F16","2":"F","3":"NA","4":"Final","5":"D","6":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","7":"<s_MULTIP>","_rn_":"4"},{"1":"F16","2":"F","3":"NA","4":"Final","5":"D","6":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","7":"<s_MULTIP>","_rn_":"5"},{"1":"F16","2":"F","3":"NA","4":"Final","5":"D","6":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","7":"<s_MULTIP>","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br>
</p>
<p>Next, we can overlay the buffer and the cropped crop layer:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(crpdst_bbox_sf, <span class="fu">aes</span>(<span class="at">fill =</span> main_crop)) <span class="sc">+</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> onefarm_buf1k,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">"red"</span>, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="fu">st_crs</span>(epsg_utm11n_wgs84)) <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"1km buffer around Point "</span>, farms_sf<span class="sc">$</span>ptid[i]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cropdist-localstats_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br>
</p>
<p>Display a “legend”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>crops_in_this_area <span class="ot">&lt;-</span> <span class="fu">unique</span>(crpdst_bbox_sf<span class="sc">$</span>main_crop)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>croptypes_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(code <span class="sc">%in%</span> crops_in_this_area)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["code"],"name":[1],"type":["chr"],"align":["left"]},{"label":["description"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"C6","2":"Olives"},{"1":"D12","2":"Almonds"},{"1":"F16","2":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)"},{"1":"G2","2":"Wheat"},{"1":"P1","2":"Alfalfa and alfalfa mixtures"},{"1":"V","2":"Vineyards - No Subclass"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br>
</p>
</section>
<section id="intersect-the-crop-polygons-with-the-buffer" class="level2">
<h2 class="anchored" data-anchor-id="intersect-the-crop-polygons-with-the-buffer">Intersect the crop polygons with the buffer</h2>
<p>Now we can take the intersection:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>crops_buf_sf <span class="ot">&lt;-</span> crpdst_bbox_sf <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(onefarm_buf1k) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">area_m2 =</span> <span class="fu">st_area</span>(Shape)) <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>description) <span class="sc">|&gt;</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(area_m2, <span class="at">.before =</span> Shape) <span class="sc">|&gt;</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(ptid, <span class="at">.before =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>crops_buf_sf <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["ptid"],"name":[1],"type":["chr"],"align":["left"]},{"label":["main_crop"],"name":[2],"type":["chr"],"align":["left"]},{"label":["class2"],"name":[3],"type":["chr"],"align":["left"]},{"label":["yr_planted"],"name":[4],"type":["int"],"align":["right"]},{"label":["data_status"],"name":[5],"type":["chr"],"align":["left"]},{"label":["multiuse"],"name":[6],"type":["chr"],"align":["left"]},{"label":["area_m2"],"name":[7],"type":["units"],"align":["right"]},{"label":["Shape"],"name":[8],"type":["s_POLYGO"],"align":["right"]}],"data":[{"1":"A","2":"F16","3":"F","4":"NA","5":"Final","6":"D","7":"272414.4362 [m^2]","8":"<s_POLYGO>","_rn_":"1"},{"1":"A","2":"F16","3":"F","4":"NA","5":"Final","6":"D","7":"359.7637 [m^2]","8":"<s_POLYGO>","_rn_":"2"},{"1":"A","2":"P1","3":"P","4":"NA","5":"Final","6":"S","7":"81803.7178 [m^2]","8":"<s_POLYGO>","_rn_":"3"},{"1":"A","2":"F16","3":"F","4":"NA","5":"Final","6":"D","7":"12899.6734 [m^2]","8":"<s_POLYGO>","_rn_":"4"},{"1":"A","2":"F16","3":"F","4":"NA","5":"Final","6":"D","7":"166311.1766 [m^2]","8":"<s_POLYGO>","_rn_":"5"},{"1":"A","2":"F16","3":"F","4":"NA","5":"Final","6":"D","7":"207243.3563 [m^2]","8":"<s_POLYGO>","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br>
</p>
<p>Plot these together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(crops_buf_sf, <span class="fu">aes</span>(<span class="at">fill =</span> main_crop)) <span class="sc">+</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> onefarm_buf1k,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">"red"</span>, </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="fu">st_crs</span>(epsg_utm11n_wgs84)) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"1km buffer around Point #"</span>, i))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cropdist-localstats_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks good!</p>
<p><br>
</p>
</section>
<section id="compute-the-percent-area-of-each-crop" class="level2">
<h2 class="anchored" data-anchor-id="compute-the-percent-area-of-each-crop">Compute the percent area of each crop</h2>
<p>We can now compute the percent of the buffer zone area for each crop:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_tbl <span class="ot">&lt;-</span> crops_buf_sf <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(main_crop) <span class="sc">|&gt;</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_area =</span> <span class="fu">round</span>(<span class="fu">sum</span>(area_m2)), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prcnt_buf =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(total_area <span class="sc">/</span> buff_area_m2), <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(croptypes_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"main_crop"</span> <span class="ot">=</span> <span class="st">"code"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">crop =</span> main_crop, <span class="at">description =</span> description, total_area, prcnt_buf) <span class="sc">|&gt;</span> </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(prcnt_buf))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["crop"],"name":[1],"type":["chr"],"align":["left"]},{"label":["description"],"name":[2],"type":["chr"],"align":["left"]},{"label":["total_area"],"name":[3],"type":["units"],"align":["right"]},{"label":["prcnt_buf"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"F16","2":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","3":"1273117 [m^2]","4":"0.41"},{"1":"G2","2":"Wheat","3":"611365 [m^2]","4":"0.19"},{"1":"C6","2":"Olives","3":"578587 [m^2]","4":"0.18"},{"1":"D12","2":"Almonds","3":"299657 [m^2]","4":"0.10"},{"1":"V","2":"Vineyards - No Subclass","3":"142590 [m^2]","4":"0.05"},{"1":"P1","2":"Alfalfa and alfalfa mixtures","3":"81804 [m^2]","4":"0.03"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br>
</p>
<p>View the total percent area (should be close to 1.0):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_tbl<span class="sc">$</span>prcnt_buf <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.96</code></pre>
</div>
</div>
<p><br>
</p>
</section>
<section id="add-the-non-crop-category" class="level2">
<h2 class="anchored" data-anchor-id="add-the-non-crop-category">Add the ‘non-crop’ category:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>noncrop_area <span class="ot">&lt;-</span> crop_prcntbuf_tbl<span class="sc">$</span>prcnt_buf <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>nnocrop_prct <span class="ot">&lt;-</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_nocrop_tbl <span class="ot">&lt;-</span> crop_prcntbuf_tbl <span class="sc">|&gt;</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">crop =</span> <span class="st">"NA"</span>, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">description =</span> <span class="st">"Non-Crop"</span>, </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">total_area =</span> <span class="fu">round</span>(buff_area_m2 <span class="sc">-</span> <span class="fu">sum</span>(crop_prcntbuf_tbl<span class="sc">$</span>total_area)),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">prcnt_buf =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(crop_prcntbuf_tbl<span class="sc">$</span>prcnt_buf)))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_nocrop_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["crop"],"name":[1],"type":["chr"],"align":["left"]},{"label":["description"],"name":[2],"type":["chr"],"align":["left"]},{"label":["total_area"],"name":[3],"type":["units"],"align":["right"]},{"label":["prcnt_buf"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"F16","2":"Corn, Sorghum or Sudan (grouped for remote sensing classification only)","3":"1273117 [m^2]","4":"0.41"},{"1":"G2","2":"Wheat","3":"611365 [m^2]","4":"0.19"},{"1":"C6","2":"Olives","3":"578587 [m^2]","4":"0.18"},{"1":"D12","2":"Almonds","3":"299657 [m^2]","4":"0.10"},{"1":"V","2":"Vineyards - No Subclass","3":"142590 [m^2]","4":"0.05"},{"1":"P1","2":"Alfalfa and alfalfa mixtures","3":"81804 [m^2]","4":"0.03"},{"1":"__NA__","2":"Non-Crop","3":"153037 [m^2]","4":"0.04"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br>
</p>
<p>Make a pie chart:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>caption_chr <span class="ot">&lt;-</span> crop_prcntbuf_nocrop_tbl <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(crop) <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">crop_description_chr =</span> <span class="fu">paste</span>(crop, description, <span class="at">sep =</span> <span class="st">": "</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(crop_description_chr) <span class="sc">|&gt;</span> </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">"; "</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">strwrap</span>(<span class="at">width =</span> <span class="dv">80</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(crop_prcntbuf_nocrop_tbl, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> prcnt_buf, <span class="at">fill =</span> crop)) <span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">width =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="st">"y"</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Percent area of each crop type"</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"1km buffer around Point "</span>, farms_sf<span class="sc">$</span>ptid[i]), </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> caption_chr) <span class="sc">+</span> </span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cropdist-localstats_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>The next step could be to wrap this in a ‘production script’ that:</p>
<ul>
<li>loops through multiple points<br>
</li>
<li>loops through multiple buffer distances</li>
<li>spits out a table that has the combined percent areas for all points and buffers (and can be easily reshaped or filtered for further analyses)</li>
</ul>
<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The crop distribution layer is updated every year, but as of the date of this notebook 2021 was the most recent year that was labeled as “final”.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Using a projected CRS is required in this case, because we’re going to create buffers around each point using a radius expressed in real-world-coordinates.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Well Known Text<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb38" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Summarizing Crop Distribution for a Polygon"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Andy Lyons"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "September 25, 2024"</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 2</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary </span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>This notebook demonstrates the code that can be used to summarize the distribution of crops around a point. It uses the 2021^<span class="co">[</span><span class="ot">The crop distribution layer is updated every year, but as of the date of this notebook 2021 was the most recent year that was labeled as "final".</span><span class="co">] [Statewide Crop Mapping Layer]</span>(https://data.cnra.ca.gov/dataset/statewide-crop-mapping) from <span class="co">[</span><span class="ot">CA DWR</span><span class="co">](https://data.cnra.ca.gov/organization/dwr)</span>. </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>More specifically, this notebook shows how to:</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>import a set of points from a CSV file</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>create a spatial object from the CSV file</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>select one of the points</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>create a 1km buffer around the point</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>import the 2021 Statewide Crop Mapping Layer from a downloaded file geodatabase for the area of the buffer</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>intersect the buffer with the crop polygons</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>compute for each crop the percent of the total area of the buffer</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>This demonstration code is intended to be educational, but can be adapted into a "production script" that chugs through a series of points and a range of buffer sizes to characterize the landscape around selected points. The methods can also be adapted for other polygons (e.g., ground water basins, counties, etc.)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>We first load libraries:</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message = FALSE}</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(readr)</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(leaflet)</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="in">library(units)</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>Define a few EPSG codes (i.e., projections) that we'll use later:</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>epsg_utm11n_wgs84 <span class="ot">&lt;-</span> <span class="dv">32611</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>epsg_geo_nad83 <span class="ot">&lt;-</span> <span class="dv">4269</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>epsg_geo_wgs84 <span class="ot">&lt;-</span> <span class="dv">4326</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a><span class="fu">## Import points</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>First, we load some points from a CSV file. </span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>farms_tbl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"farm_pts.csv"</span>)</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>farms_tbl</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Importing Points"}</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>If the points are already in a GIS format (e.g., Shapefile, KML), we would import them using <span class="in">`st_read()`</span> (and skip the next step).</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a><span class="fu">## Convert points to spatial object</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>Next, we convert this to a simple feature point layer in UTM Zone 11^<span class="co">[</span><span class="ot">Using a projected CRS is required in this case, because we're going to create buffers around each point using a radius expressed in real-world-coordinates.</span><span class="co">]</span>:</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>farms_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(farms_tbl, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> epsg_geo_wgs84) <span class="sc">|&gt;</span> </span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(epsg_utm11n_wgs84)</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>Plot these points in a leaflet map to see where they are:</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> <span class="fu">st_transform</span>(farms_sf, epsg_geo_wgs84)) <span class="sc">|&gt;</span> </span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(<span class="st">"Esri.WorldImagery"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>  leaflet<span class="sc">::</span><span class="fu">addCircleMarkers</span>(<span class="at">stroke =</span> <span class="cn">FALSE</span>, </span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fillColor =</span> <span class="st">"#f00"</span>, </span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fillOpacity =</span> <span class="fl">0.8</span>,</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>                            <span class="at">popup =</span> <span class="sc">~</span>id)</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Open a Connection to the 2021 Statewide Crop Mapping data</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>This notebook uses a local copy of the 2021 Statewide Crop Mapping saved as a file geodatabase. This copy was downloaded from the <span class="co">[</span><span class="ot">CNRA Open Data Hub</span><span class="co">](https://data.cnra.ca.gov/dataset/statewide-crop-mapping/resource/cd1ce211-ac75-44b4-9ea4-345ce2fd0548)</span> and unzipped. </span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>We are using a local copy of the crop distribution data because:</span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>accessing a local file geodatabase will give us the fastest performance (compared to downloading the data from the cloud, although that can also be done).</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>the size of the data is manageable (the zip file is 90 MB, the unzipped GDB is 207 MB).</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>the links to the online layers (i.e., Map Service) seem to be broken (or require a login), so there is not much alternative.</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>Create the connection and view the layers:</span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>dwr_cropmapping_gdb <span class="ot">&lt;-</span> <span class="st">"i15_Crop_Mapping_2021_GDB/i15_Crop_Mapping_2021.gdb"</span></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.exists</span>(dwr_cropmapping_gdb)</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(dwr_cropmapping_gdb)</span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exploring the Statewide Crop Distribution Layer</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>The best way to explore the Statewide Crop Distribution Layer is to open it up in ArcGIS Pro. The zip file from DWR contains both a file geodatabase as well as an ArcGIS Pro layer file (<span class="in">`CropMapping2021_Legend.lyrx`</span>). Double-click the layer file to open it up in ArcGIS Pro. You will probably need to reestablish the link to the data (layer properties &gt; source), but then you're good to go.</span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>The file geodatabase appears to be the only source for 'metadata'. In other words, DWR has not published the metadata anywhere else, however  copy of the metadata for the 2021 crop distribution data can also be found <span class="co">[</span><span class="ot">here</span><span class="co">](https://ucanr-igis.github.io/sketchbook/i15_Crop_Mapping_2021_metdata.htm)</span>. However even the 'metadata' does not provide a field-by-field description, but you can make educated guesses by looking at the field properties and domains (see below). </span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Exploring the Data in ArcGIS Pro"}</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>Reading the metadata and exploring the data more thoroughly in ArcGIS Pro is an extremely good idea if you'll be using these data for research. In addition to the <span class="in">`MAIN_CROP`</span> field (which is all we're using in this notebook), there are 56 other fields that contain useful information including multi-cropping characteristics, crop category (as opposed to crop type), year the crop was established (i.e., for perennial crops), whether the classification was updated / revised by DWR, notes from the analyst, etc. </span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a><span class="fu">## Which attribute field contains 'the crop'?</span></span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>The attribute table for the Statewide Crop Mapping layer has **57 fields**. Determining which field has the "crop" name requires some sleuthing, as there are several candidates whose name suggest it might be the crop name. DWR unfortunately does not publish a data dictionary for the data, but if you open the file geodatabase in ArcGIS Pro you can see i) the 'domains' (list of codes and their descriptions used in several fields), and ii) <span class="co">[</span><span class="ot">descriptive metadata</span><span class="co">](https://ucanr-igis.github.io/sketchbook/i15_Crop_Mapping_2021_metdata.htm)</span> that contains clues about the methodology.</span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>The code in this notebook only imports **5** of the 57 fields. The field we will use below as "the crop" is **`MAIN_CROP`**, which the metadata describes as:</span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>:::::{style="margin-left; padding-left:1em; font-style:italic;"}</span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a>A new column for the 2019, 2020, and 2021 datasets is called ‘MAIN_CROP’. This column indicates which field Land IQ identified as the main season crop for the WY representing the crop grown during the dominant growing season for each county. </span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>:::::</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a><span class="fu">## Figuring out the codes</span></span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>Many of the attribute fields in the crop distribution layer contain codes or abbreviations. The descriptions that go with these codes are not documented anywhere online, unfortunately. However if you open the File Geodatabase in ArcGIS Pro, you view the 'domains' (which is what ESRI calls code lists used in attribute tables). For convenience, the domains have been also exported as tables saved in another file geodatabase: <span class="in">`Crop_Mapping_2021_domains.gdb`</span>.</span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a>domains_gdb <span class="ot">&lt;-</span> <span class="st">"Crop_Mapping_2021_domains.gdb"</span></span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.exists</span>(domains_gdb)</span>
<span id="cb38-162"><a href="#cb38-162" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(domains_gdb)</span>
<span id="cb38-163"><a href="#cb38-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-165"><a href="#cb38-165" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-166"><a href="#cb38-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-167"><a href="#cb38-167" aria-hidden="true" tabindex="-1"></a>All 9 of these 'domains' are code lists used in one or more of the 57 fields in the attribute table. </span>
<span id="cb38-168"><a href="#cb38-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-169"><a href="#cb38-169" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-170"><a href="#cb38-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-171"><a href="#cb38-171" aria-hidden="true" tabindex="-1"></a><span class="fu">## Import the Crop Type codes</span></span>
<span id="cb38-172"><a href="#cb38-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-173"><a href="#cb38-173" aria-hidden="true" tabindex="-1"></a>Let's import the "crop types" domain:</span>
<span id="cb38-174"><a href="#cb38-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-177"><a href="#cb38-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-178"><a href="#cb38-178" aria-hidden="true" tabindex="-1"></a>croptypes_tbl <span class="ot">&lt;-</span> <span class="fu">st_read</span>(domains_gdb, </span>
<span id="cb38-179"><a href="#cb38-179" aria-hidden="true" tabindex="-1"></a>                         <span class="at">layer =</span> <span class="st">"allCropType_dom_3"</span>, </span>
<span id="cb38-180"><a href="#cb38-180" aria-hidden="true" tabindex="-1"></a>                         <span class="at">as_tibble =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-181"><a href="#cb38-181" aria-hidden="true" tabindex="-1"></a>                         <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-182"><a href="#cb38-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">code =</span> Code, <span class="at">description =</span> Description)</span>
<span id="cb38-183"><a href="#cb38-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-184"><a href="#cb38-184" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(croptypes_tbl, <span class="at">format =</span> <span class="st">"html"</span>)</span>
<span id="cb38-185"><a href="#cb38-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-186"><a href="#cb38-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-187"><a href="#cb38-187" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-188"><a href="#cb38-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-189"><a href="#cb38-189" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create a buffer </span></span>
<span id="cb38-190"><a href="#cb38-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-191"><a href="#cb38-191" aria-hidden="true" tabindex="-1"></a>Next, we'll create a buffer around one of the points to use as the 'cookie cutter' for the crop distribution layer. For the rest of this notebook, we'll be working with just one of the points (but this can be easily adapted by creating a loop).</span>
<span id="cb38-192"><a href="#cb38-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-193"><a href="#cb38-193" aria-hidden="true" tabindex="-1"></a>Set a variable for the selected point:</span>
<span id="cb38-194"><a href="#cb38-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-197"><a href="#cb38-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-198"><a href="#cb38-198" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb38-199"><a href="#cb38-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-200"><a href="#cb38-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-201"><a href="#cb38-201" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-202"><a href="#cb38-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-203"><a href="#cb38-203" aria-hidden="true" tabindex="-1"></a>Make a 1km buffer around the ith point:</span>
<span id="cb38-204"><a href="#cb38-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-207"><a href="#cb38-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-208"><a href="#cb38-208" aria-hidden="true" tabindex="-1"></a>onefarm_buf1k <span class="ot">&lt;-</span> farms_sf <span class="sc">|&gt;</span> </span>
<span id="cb38-209"><a href="#cb38-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb38-210"><a href="#cb38-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="at">dist =</span> <span class="dv">1000</span>) </span>
<span id="cb38-211"><a href="#cb38-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-212"><a href="#cb38-212" aria-hidden="true" tabindex="-1"></a>onefarm_buf1k</span>
<span id="cb38-213"><a href="#cb38-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-214"><a href="#cb38-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-215"><a href="#cb38-215" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-216"><a href="#cb38-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-217"><a href="#cb38-217" aria-hidden="true" tabindex="-1"></a>See what that looks like:</span>
<span id="cb38-218"><a href="#cb38-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-221"><a href="#cb38-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-222"><a href="#cb38-222" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(onefarm_buf1k<span class="sc">$</span>geometry, <span class="at">axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-223"><a href="#cb38-223" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-224"><a href="#cb38-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-225"><a href="#cb38-225" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-226"><a href="#cb38-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-227"><a href="#cb38-227" aria-hidden="true" tabindex="-1"></a>Compute the area of the buffer (we'll need this further down when we compute the percent area of each crop):</span>
<span id="cb38-228"><a href="#cb38-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-231"><a href="#cb38-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-232"><a href="#cb38-232" aria-hidden="true" tabindex="-1"></a>(buff_area_m2 <span class="ot">&lt;-</span> <span class="fu">st_area</span>(onefarm_buf1k))</span>
<span id="cb38-233"><a href="#cb38-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-234"><a href="#cb38-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-235"><a href="#cb38-235" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-236"><a href="#cb38-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-237"><a href="#cb38-237" aria-hidden="true" tabindex="-1"></a><span class="fu">## Import the Crop Distribution Data</span></span>
<span id="cb38-238"><a href="#cb38-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-239"><a href="#cb38-239" aria-hidden="true" tabindex="-1"></a>Next, we'll import the crop distribution layer (which is a polygon layer). To save time and memory, we'll only import polygons that intersect the buffer area by specifying a spatial filter when we call <span class="in">`st_read()`</span>.</span>
<span id="cb38-240"><a href="#cb38-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-241"><a href="#cb38-241" aria-hidden="true" tabindex="-1"></a>To include a spatial filter when we import the data, we need to define the bounding box and express it as WKT^<span class="co">[</span><span class="ot">Well Known Text</span><span class="co">]</span> (i.e., a character object). Note that we also have to transform the bounding box to geographic coordinates NAD83, because that's the CRS of the crop distribution layer.</span>
<span id="cb38-242"><a href="#cb38-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-245"><a href="#cb38-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-246"><a href="#cb38-246" aria-hidden="true" tabindex="-1"></a>bbox_wkt <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(onefarm_buf1k) <span class="sc">|&gt;</span> </span>
<span id="cb38-247"><a href="#cb38-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb38-248"><a href="#cb38-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(epsg_geo_nad83) <span class="sc">|&gt;</span> </span>
<span id="cb38-249"><a href="#cb38-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_text</span>()</span>
<span id="cb38-250"><a href="#cb38-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-251"><a href="#cb38-251" aria-hidden="true" tabindex="-1"></a>bbox_wkt</span>
<span id="cb38-252"><a href="#cb38-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-253"><a href="#cb38-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-254"><a href="#cb38-254" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-255"><a href="#cb38-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-256"><a href="#cb38-256" aria-hidden="true" tabindex="-1"></a>Now we can import the crop distribution layer for the bounding box:</span>
<span id="cb38-257"><a href="#cb38-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-260"><a href="#cb38-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-261"><a href="#cb38-261" aria-hidden="true" tabindex="-1"></a>crpdst_bbox_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> dwr_cropmapping_gdb,</span>
<span id="cb38-262"><a href="#cb38-262" aria-hidden="true" tabindex="-1"></a>                        <span class="at">layer =</span> <span class="st">"i15_Crop_Mapping_2021"</span>,</span>
<span id="cb38-263"><a href="#cb38-263" aria-hidden="true" tabindex="-1"></a>                        <span class="at">wkt_filter =</span> bbox_wkt) <span class="sc">|&gt;</span> </span>
<span id="cb38-264"><a href="#cb38-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(epsg_utm11n_wgs84) <span class="sc">|&gt;</span> </span>
<span id="cb38-265"><a href="#cb38-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">main_crop =</span> MAIN_CROP, <span class="at">class2 =</span> CLASS2, <span class="at">yr_planted =</span> YR_PLANTED, </span>
<span id="cb38-266"><a href="#cb38-266" aria-hidden="true" tabindex="-1"></a>         <span class="at">data_status =</span> DataStatus, <span class="at">multiuse =</span> MULTIUSE) <span class="sc">|&gt;</span> </span>
<span id="cb38-267"><a href="#cb38-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(croptypes_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"main_crop"</span> <span class="ot">=</span> <span class="st">"code"</span>))</span>
<span id="cb38-268"><a href="#cb38-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-269"><a href="#cb38-269" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(crpdst_bbox_sf)</span>
<span id="cb38-270"><a href="#cb38-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-271"><a href="#cb38-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-272"><a href="#cb38-272" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-273"><a href="#cb38-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-274"><a href="#cb38-274" aria-hidden="true" tabindex="-1"></a>Next, we can overlay the buffer and the cropped crop layer:</span>
<span id="cb38-275"><a href="#cb38-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-278"><a href="#cb38-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-279"><a href="#cb38-279" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(crpdst_bbox_sf, <span class="fu">aes</span>(<span class="at">fill =</span> main_crop)) <span class="sc">+</span> </span>
<span id="cb38-280"><a href="#cb38-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb38-281"><a href="#cb38-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> onefarm_buf1k,</span>
<span id="cb38-282"><a href="#cb38-282" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">"red"</span>, </span>
<span id="cb38-283"><a href="#cb38-283" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb38-284"><a href="#cb38-284" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb38-285"><a href="#cb38-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="fu">st_crs</span>(epsg_utm11n_wgs84)) <span class="sc">+</span></span>
<span id="cb38-286"><a href="#cb38-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"1km buffer around Point "</span>, farms_sf<span class="sc">$</span>ptid[i]))</span>
<span id="cb38-287"><a href="#cb38-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-288"><a href="#cb38-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-289"><a href="#cb38-289" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-290"><a href="#cb38-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-291"><a href="#cb38-291" aria-hidden="true" tabindex="-1"></a>Display a "legend":</span>
<span id="cb38-292"><a href="#cb38-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-295"><a href="#cb38-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-296"><a href="#cb38-296" aria-hidden="true" tabindex="-1"></a>crops_in_this_area <span class="ot">&lt;-</span> <span class="fu">unique</span>(crpdst_bbox_sf<span class="sc">$</span>main_crop)</span>
<span id="cb38-297"><a href="#cb38-297" aria-hidden="true" tabindex="-1"></a>croptypes_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(code <span class="sc">%in%</span> crops_in_this_area)</span>
<span id="cb38-298"><a href="#cb38-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-299"><a href="#cb38-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-300"><a href="#cb38-300" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-301"><a href="#cb38-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-302"><a href="#cb38-302" aria-hidden="true" tabindex="-1"></a><span class="fu">## Intersect the crop polygons with the buffer</span></span>
<span id="cb38-303"><a href="#cb38-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-304"><a href="#cb38-304" aria-hidden="true" tabindex="-1"></a>Now we can take the intersection:</span>
<span id="cb38-305"><a href="#cb38-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-308"><a href="#cb38-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-309"><a href="#cb38-309" aria-hidden="true" tabindex="-1"></a>crops_buf_sf <span class="ot">&lt;-</span> crpdst_bbox_sf <span class="sc">|&gt;</span> </span>
<span id="cb38-310"><a href="#cb38-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(onefarm_buf1k) <span class="sc">|&gt;</span> </span>
<span id="cb38-311"><a href="#cb38-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">area_m2 =</span> <span class="fu">st_area</span>(Shape)) <span class="sc">|&gt;</span> </span>
<span id="cb38-312"><a href="#cb38-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>description) <span class="sc">|&gt;</span> </span>
<span id="cb38-313"><a href="#cb38-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(area_m2, <span class="at">.before =</span> Shape) <span class="sc">|&gt;</span> </span>
<span id="cb38-314"><a href="#cb38-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(ptid, <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb38-315"><a href="#cb38-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-316"><a href="#cb38-316" aria-hidden="true" tabindex="-1"></a>crops_buf_sf <span class="sc">|&gt;</span> <span class="fu">head</span>()</span>
<span id="cb38-317"><a href="#cb38-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-318"><a href="#cb38-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-319"><a href="#cb38-319" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-320"><a href="#cb38-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-321"><a href="#cb38-321" aria-hidden="true" tabindex="-1"></a>Plot these together:</span>
<span id="cb38-322"><a href="#cb38-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-325"><a href="#cb38-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-326"><a href="#cb38-326" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(crops_buf_sf, <span class="fu">aes</span>(<span class="at">fill =</span> main_crop)) <span class="sc">+</span> </span>
<span id="cb38-327"><a href="#cb38-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb38-328"><a href="#cb38-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> onefarm_buf1k,</span>
<span id="cb38-329"><a href="#cb38-329" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">"red"</span>, </span>
<span id="cb38-330"><a href="#cb38-330" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb38-331"><a href="#cb38-331" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb38-332"><a href="#cb38-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="fu">st_crs</span>(epsg_utm11n_wgs84)) <span class="sc">+</span></span>
<span id="cb38-333"><a href="#cb38-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"1km buffer around Point #"</span>, i))</span>
<span id="cb38-334"><a href="#cb38-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-335"><a href="#cb38-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-336"><a href="#cb38-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-337"><a href="#cb38-337" aria-hidden="true" tabindex="-1"></a>This looks good!</span>
<span id="cb38-338"><a href="#cb38-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-339"><a href="#cb38-339" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-340"><a href="#cb38-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-341"><a href="#cb38-341" aria-hidden="true" tabindex="-1"></a><span class="fu">## Compute the percent area of each crop</span></span>
<span id="cb38-342"><a href="#cb38-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-343"><a href="#cb38-343" aria-hidden="true" tabindex="-1"></a>We can now compute the percent of the buffer zone area for each crop:</span>
<span id="cb38-344"><a href="#cb38-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-347"><a href="#cb38-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-348"><a href="#cb38-348" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_tbl <span class="ot">&lt;-</span> crops_buf_sf <span class="sc">|&gt;</span> </span>
<span id="cb38-349"><a href="#cb38-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb38-350"><a href="#cb38-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(main_crop) <span class="sc">|&gt;</span> </span>
<span id="cb38-351"><a href="#cb38-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_area =</span> <span class="fu">round</span>(<span class="fu">sum</span>(area_m2)), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-352"><a href="#cb38-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prcnt_buf =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(total_area <span class="sc">/</span> buff_area_m2), <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb38-353"><a href="#cb38-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(croptypes_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"main_crop"</span> <span class="ot">=</span> <span class="st">"code"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb38-354"><a href="#cb38-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">crop =</span> main_crop, <span class="at">description =</span> description, total_area, prcnt_buf) <span class="sc">|&gt;</span> </span>
<span id="cb38-355"><a href="#cb38-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(prcnt_buf))</span>
<span id="cb38-356"><a href="#cb38-356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-357"><a href="#cb38-357" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_tbl</span>
<span id="cb38-358"><a href="#cb38-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-359"><a href="#cb38-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-360"><a href="#cb38-360" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-361"><a href="#cb38-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-362"><a href="#cb38-362" aria-hidden="true" tabindex="-1"></a>View the total percent area (should be close to 1.0):</span>
<span id="cb38-363"><a href="#cb38-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-366"><a href="#cb38-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-367"><a href="#cb38-367" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_tbl<span class="sc">$</span>prcnt_buf <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span>
<span id="cb38-368"><a href="#cb38-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-369"><a href="#cb38-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-370"><a href="#cb38-370" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-371"><a href="#cb38-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-372"><a href="#cb38-372" aria-hidden="true" tabindex="-1"></a><span class="fu">## Add the 'non-crop' category:</span></span>
<span id="cb38-373"><a href="#cb38-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-376"><a href="#cb38-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-377"><a href="#cb38-377" aria-hidden="true" tabindex="-1"></a>noncrop_area <span class="ot">&lt;-</span> crop_prcntbuf_tbl<span class="sc">$</span>prcnt_buf <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span>
<span id="cb38-378"><a href="#cb38-378" aria-hidden="true" tabindex="-1"></a>nnocrop_prct <span class="ot">&lt;-</span> </span>
<span id="cb38-379"><a href="#cb38-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-380"><a href="#cb38-380" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_nocrop_tbl <span class="ot">&lt;-</span> crop_prcntbuf_tbl <span class="sc">|&gt;</span> </span>
<span id="cb38-381"><a href="#cb38-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">crop =</span> <span class="st">"NA"</span>, </span>
<span id="cb38-382"><a href="#cb38-382" aria-hidden="true" tabindex="-1"></a>                   <span class="at">description =</span> <span class="st">"Non-Crop"</span>, </span>
<span id="cb38-383"><a href="#cb38-383" aria-hidden="true" tabindex="-1"></a>                   <span class="at">total_area =</span> <span class="fu">round</span>(buff_area_m2 <span class="sc">-</span> <span class="fu">sum</span>(crop_prcntbuf_tbl<span class="sc">$</span>total_area)),</span>
<span id="cb38-384"><a href="#cb38-384" aria-hidden="true" tabindex="-1"></a>                   <span class="at">prcnt_buf =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(crop_prcntbuf_tbl<span class="sc">$</span>prcnt_buf)))</span>
<span id="cb38-385"><a href="#cb38-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-386"><a href="#cb38-386" aria-hidden="true" tabindex="-1"></a>crop_prcntbuf_nocrop_tbl</span>
<span id="cb38-387"><a href="#cb38-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-388"><a href="#cb38-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-389"><a href="#cb38-389" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb38-390"><a href="#cb38-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-391"><a href="#cb38-391" aria-hidden="true" tabindex="-1"></a>Make a pie chart:</span>
<span id="cb38-392"><a href="#cb38-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-395"><a href="#cb38-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-396"><a href="#cb38-396" aria-hidden="true" tabindex="-1"></a>caption_chr <span class="ot">&lt;-</span> crop_prcntbuf_nocrop_tbl <span class="sc">|&gt;</span> </span>
<span id="cb38-397"><a href="#cb38-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(crop) <span class="sc">|&gt;</span> </span>
<span id="cb38-398"><a href="#cb38-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">crop_description_chr =</span> <span class="fu">paste</span>(crop, description, <span class="at">sep =</span> <span class="st">": "</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb38-399"><a href="#cb38-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(crop_description_chr) <span class="sc">|&gt;</span> </span>
<span id="cb38-400"><a href="#cb38-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">"; "</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-401"><a href="#cb38-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">strwrap</span>(<span class="at">width =</span> <span class="dv">80</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-402"><a href="#cb38-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-403"><a href="#cb38-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-404"><a href="#cb38-404" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(crop_prcntbuf_nocrop_tbl, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> prcnt_buf, <span class="at">fill =</span> crop)) <span class="sc">+</span></span>
<span id="cb38-405"><a href="#cb38-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">width =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-406"><a href="#cb38-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="st">"y"</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb38-407"><a href="#cb38-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb38-408"><a href="#cb38-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Percent area of each crop type"</span>,</span>
<span id="cb38-409"><a href="#cb38-409" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"1km buffer around Point "</span>, farms_sf<span class="sc">$</span>ptid[i]), </span>
<span id="cb38-410"><a href="#cb38-410" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> caption_chr) <span class="sc">+</span> </span>
<span id="cb38-411"><a href="#cb38-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>))</span>
<span id="cb38-412"><a href="#cb38-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-413"><a href="#cb38-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-414"><a href="#cb38-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-415"><a href="#cb38-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-416"><a href="#cb38-416" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb38-417"><a href="#cb38-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-418"><a href="#cb38-418" aria-hidden="true" tabindex="-1"></a>The next step could be to wrap this in a 'production script' that:</span>
<span id="cb38-419"><a href="#cb38-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-420"><a href="#cb38-420" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>loops through multiple points  </span>
<span id="cb38-421"><a href="#cb38-421" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>loops through multiple buffer distances</span>
<span id="cb38-422"><a href="#cb38-422" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>spits out a table that has the combined percent areas for all points and buffers (and can be easily reshaped or filtered for further analyses)</span>
<span id="cb38-423"><a href="#cb38-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-424"><a href="#cb38-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-425"><a href="#cb38-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-426"><a href="#cb38-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-427"><a href="#cb38-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-428"><a href="#cb38-428" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>